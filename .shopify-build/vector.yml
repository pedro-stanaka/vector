containers:
  default:
    docker: rust:1.64.0-bullseye

steps:
  - label: Prepare and Build Vector
    timeout: 180m
    run:
    - apt update --yes
    - |
      apt install --yes \
        software-properties-common \
        apt-utils \
        apt-transport-https
    - apt upgrade --yes
    - | 
      apt install --yes \
        awscli \
        build-essential \
        ca-certificates \
        cmake \
        cmark-gfm \
        curl \
        gawk \
        gnupg2 \
        gnupg-agent \
        gnuplot \
        jq \
        libclang-dev \
        libsasl2-dev \
        libssl-dev \
        llvm \
        locales \
        nodejs \
        npm \
        pkg-config \
        python3-pip \
        rename \
        rpm \
        ruby-bundler \
        shellcheck \
        sudo \
        unzip \
        wget \
        yarn
    - apt clean

    - bash scripts/environment/install-protoc.sh
    - rustup target add x86_64-unknown-linux-gnu
    # - make package-x86_64-unknown-linux-gnu-all
    - cargo fetch
    - PATH="$PATH:$(pwd)/bin" cargo build --target=x86_64-unknown-linux-gnu --release
    cache:
    - ~/.cargo/registry
    - ~/.cargo/git
    - target
    timeout: 180m
    env:
      SHOPIFY_BUILD_MEMORY_LIMIT: 10g
      SHOPIFY_BUILD_CPU_LIMIT: '4'